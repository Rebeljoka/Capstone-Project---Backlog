{% extends 'base.html' %} {% load static %} {% block content %}
<section class="text-center hero-section overflow-hidden">
	<img src="{% static 'images/hero.jpg' %}" alt="Logo" id="hero-img" class="mx-auto blur-md scale-105 bg-center hero-img" />
	<div class="grid place-items-center absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
		<h1 class="text-4xl md:text-5xl font-bold text-white mb-4">Welcome to Backlog.</h1>
		<h2 class="text-xl md:text-2xl text-white mb-6">Organize your gaming journey.</h2>
		<h3 class="text-md md:text-lg text-white mb-6">Track your game collection, create custom wishlists, and discover new games.</h3>
		<h4 class="text-md md:text-lg text-white mb-6">Browse our extensive library of games today and Sign up!</h4>
		<div class="flex flex-row justify-center gap-4 mt-2">
			<a href="{% url 'account_signup' %}" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg text-lg font-medium transition-colors shadow-md hover:shadow-lg">Sign Up</a>
			<a href="{% url 'game_list' %}" class="px-6 py-3 text-white rounded-lg text-lg font-medium shadow-md hover:shadow-lg rainbow-btn">Get Started</a>
		</div>
	</div>
</section>

<!-- Popular Wishlisted Games -->
<section class="w-full py-12 mb-12 mt-12">
	<div class="mb-8 mt-8">
		<h1 class="text-4xl md:text-4xl lg:text-5xl font-bold text-center">Popular Wishlisted Games</h1>
	</div>

	<div class="popular-grid w-[75vw] mx-auto px-6">
		{% for game in popular_games|slice:":5" %}
		<div class="popular-card flex flex-col h-full rounded-xl shadow-lg gap-y-4" style="background-color:var(--color-card-bg);">
			<a href="{% url 'game_detail' game.game_id %}" class="block overflow-hidden rounded-t-xl">
				<div class="relative">
					{% if game.image %}
					<img class="w-full h-48 object-cover" src="{{ game.image }}" alt="{{ game.title }} cover" />
					{% else %}
					<img class="w-full h-48 object-cover" src="{% static 'images/placeholder.png' %}" alt="placeholder cover" />
					{% endif %}
					<span class="absolute top-2 right-2 badge badge-primary badge-lg">POPULAR</span>
				</div>
			</a>
			<div class="flex flex-col flex-1 px-6 py-5 gap-4">
				<div class="w-full max-w-full">
					<a href="{% url 'game_detail' game.game_id %}">
						<h5 class="text-2xl font-semibold tracking-tight text-gray-900 dark:text-white text-center leading-snug overflow-hidden text-ellipsis whitespace-nowrap">{{ game.title }}</h5>
					</a>
				</div>
				<div class="flex items-center justify-center gap-2 text-xl font-semibold">
					<span class="nf nf-oct-heart text-red-500 text-3xl"></span>
					<span>{{ game.wishlist_count|default:0 }}</span>
				</div>
				<div class="mt-auto flex flex-col gap-3 pt-2 pb-4">
					<a href="{% url 'game_detail' game.game_id %}" class="w-full text-center text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-lg py-2 whitespace-normal">View details</a>
					<a href="{% url 'add_steam_game_to_wishlist' game.game_id %}" class="w-full text-center btn btn-outline btn-secondary btn-md text-lg whitespace-normal">Add to Wishlist!</a>
				</div>
			</div>
		</div>
		{% empty %}
		<p class="text-center text-lg text-gray-500">No popular games yet — add some to your wishlist to see them here!</p>
		{% endfor %}
	</div>
</section>

<!-- Analytics Section -->
<section class="w-full py-16">
	<div class="w-[75vw] mx-auto px-6">
		<div class="text-center mb-12">
			<h1 class="text-4xl md:text-4xl lg:text-5xl font-bold mb-8 text-center">Community Insights</h1>
			<p class="text-lg md:text-xl text-gray-600 dark:text-gray-300 max-w-3xl mx-auto">
				Explore how players are building their libraries — from wishlist surges to rising engagement. These charts show what’s catching attention across the community.
			</p>
		</div>

		<div class="flex justify-center">

		{% if chart_error %}
		<div class="w-[75vw] mx-auto mb-6 px-6 py-4 bg-red-100 text-red-800 rounded-lg border border-red-200">
			<strong>Analytics error:</strong> Charts failed to generate on the server. Check server logs for details.
			{% if chart_error_msg %}<div class="mt-2 text-sm">{{ chart_error_msg }}</div>{% endif %}
		</div>
		{% endif %}

			<div class="">
				<h2 class="text-2xl font-semibold">Users vs Visitors</h2>
				<div class="w-full flex justify-center">
					{% if traffic_chart_div %}
					{{ traffic_chart_div|safe }}
					{% else %}
					<p class="text-center text-gray-500">Analytics data coming soon.</p>
					{% endif %}
				</div>
				<ul class="w-full space-y-2 text-center text-base md:text-lg">
					<li><span class="font-semibold">Registered users:</span> {{ traffic_summary.total_users }}</li>
					<li><span class="font-semibold">New in last 7 days:</span> {{ traffic_summary.new_users_last_week }}</li>
					<li><span class="font-semibold">Visitors (7 days):</span> {{ traffic_summary.visitors_last_week }}</li>
					<li><span class="font-semibold">Visitors (all-time):</span> {{ traffic_summary.visitors_all_time }}</li>
				</ul>
			</div>

			<div class="">
				<h2 class="text-2xl font-semibold">Wishlist Engagement</h2>
				<div class="w-full flex justify-center">
					{% if engagement_chart_div %}
					{{ engagement_chart_div|safe }}
					{% else %}
					<p class="text-center text-gray-500">Engagement metrics will appear once users start building wishlists.</p>
					{% endif %}
				</div>
				<ul class="w-full space-y-2 text-center text-base md:text-lg">
					<li><span class="font-semibold">Avg wishlists per user:</span> {{ engagement_summary.average_wishlists|floatformat:1 }}</li>
					<li><span class="font-semibold">Users with wishlists:</span> {{ engagement_summary.users_with_wishlist }}</li>
					<li><span class="font-semibold">Adoption rate:</span> {{ engagement_summary.adoption_percent|floatformat:1 }}%</li>
					<li><span class="font-semibold">Extra wishlists:</span> {{ engagement_summary.additional_wishlists }}</li>
				</ul>
			</div>
			
			<div class="">
				<h2 class="text-2xl font-semibold">Wishlist Velocity</h2>
				<div class="w-full flex justify-center">
					{% if wishlist_chart_div %}
					{{ wishlist_chart_div|safe }}
					{% else %}
					<p class="text-center text-gray-500">No wishlist activity recorded yet.</p>
					{% endif %}
				</div>
				<ul class="w-full space-y-2 text-center text-base md:text-lg">
					<li><span class="font-semibold">Total wishlists:</span> {{ wishlist_summary.total_wishlists }}</li>
					<li><span class="font-semibold">Created today:</span> {{ wishlist_summary.created_today }}</li>
					<li><span class="font-semibold">Created last 7 days:</span> {{ wishlist_summary.created_last_week }}</li>
					<li><span class="font-semibold">Created last 30 days:</span> {{ wishlist_summary.created_last_month }}</li>
				</ul>
			</div>
		</div>
	</div>
</section>

<section>
	<img src="{% static 'images/form-bg.jpg' %}" alt="formbg" class="w-full" />
</section>

{% if bokeh_css %}
	{% for css_url in bokeh_css %}
	<link rel="stylesheet" href="{{ css_url }}" />
	{% endfor %}
{% endif %}

{% if bokeh_js %}
	{% for js_url in bokeh_js %}
	<script src="{{ js_url }}"></script>
	{% endfor %}
{% endif %}

<!-- Diagnostics: register global error/unhandledrejection handlers BEFORE executing Bokeh embed -->
<script>
	// Minimal safe visible logging helper for remote testers
	(function () {
		// Create or reuse an error panel so remote testers can copy stacks
		if (!document.getElementById('client-error-log')) {
			const panel = document.createElement('div');
			panel.id = 'client-error-log';
			panel.style.cssText = 'display:none;position:fixed;left:1rem;bottom:1rem;right:1rem;max-height:40vh;overflow:auto;background:rgba(0,0,0,0.85);color:#fff;padding:1rem;border-radius:8px;z-index:999999;font-family:monospace;font-size:12px;white-space:pre-wrap;';
			panel.innerHTML = `\n                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">\n                    <strong>Client error log</strong>\n                    <button id="client-error-log-close" style="background:#fff;border:none;padding:0.2rem 0.4rem;border-radius:4px;cursor:pointer;">Close</button>\n                </div>\n                <pre id="client-error-log-pre" style="margin:0;white-space:pre-wrap;"></pre>`;
			document.body.appendChild(panel);
			document.getElementById('client-error-log-close').addEventListener('click', function () { panel.style.display = 'none'; });
		}

		const panel = document.getElementById('client-error-log');
		const pre = document.getElementById('client-error-log-pre');

		window.__showClientError = function (msg) {
			try {
				if (!panel || !pre) return;
				pre.textContent = (pre.textContent ? pre.textContent + '\n\n' : '') + msg;
				panel.style.display = 'block';
			} catch (err) { console.error('showClientError failed', err); }
		};

		window.addEventListener('error', function (e) {
			try {
				const stack = (e.error && e.error.stack) || e.message || String(e);
				console.error('Captured error:', stack);
				window.__showClientError('Error: ' + stack);
			} catch (err) { console.error('error handler failed', err); }
		});

		window.addEventListener('unhandledrejection', function (e) {
			try {
				const reason = e.reason && (e.reason.stack || e.reason.message) || JSON.stringify(e.reason) || String(e.reason);
				console.error('Unhandled rejection:', reason);
				window.__showClientError('Unhandled rejection: ' + reason);
			} catch (err) { console.error('unhandledrejection handler failed', err); }
		});

		// Small helper to outline Bokeh root elements and log Bokeh documents
		setTimeout(function () {
			try {
				if (window.Bokeh) {
					console.log('[diag] Bokeh version', Bokeh && Bokeh.version);
					console.log('[diag] Bokeh.documents.length', Bokeh && Bokeh.documents && Bokeh.documents.length);
					document.querySelectorAll('.bk-root').forEach(function (el) {
						console.log('[diag] bk-root rect', el.getBoundingClientRect());
						el.style.outline = '3px dashed lime';
					});
				} else {
					console.log('[diag] Bokeh not present');
				}
			} catch (err) {
				console.error('[diag] error running diagnostics', err);
			}
		}, 1000);
	})();
</script>

<!-- Execute Bokeh embed script inside a guarded evaluator so we can capture and display any stack traces and prevent re-entrant embed runs -->
{% if chart_script %}
<script id="bokeh-raw-script" type="text/plain">{{ chart_script|safe }}</script>
<script>
	(function () {
		try {
			// Prevent double execution
			if (window.__bokeh_embed_executed) return;
			window.__bokeh_embed_executed = true;

			var raw = document.getElementById('bokeh-raw-script');
			if (!raw) return;
			var s = raw.textContent || raw.innerText || '';

			// Strip surrounding <script> tags if components() returned them
			s = s.replace(/^\s*<script[^>]*>/i, '').replace(/<\/script>\s*$/i, '');

			// Evaluate the Bokeh embed script in a try/catch so we can capture deep stacks
			try {
				// Use Function constructor to keep same global scope as normal script execution
				var fn = new Function(s);
				fn();
			} catch (innerErr) {
				console.error('Bokeh embed execution error', innerErr, innerErr && innerErr.stack);
				if (window.__showClientError) {
					window.__showClientError('Bokeh embed error: ' + (innerErr && innerErr.stack ? innerErr.stack : String(innerErr)));
				}
			}
		} catch (e) {
			console.error('Failed to run guarded Bokeh embed', e, e && e.stack);
			if (window.__showClientError) window.__showClientError('Guarded Bokeh embed failed: ' + (e && e.stack ? e.stack : String(e)));
		}
	})();
</script>
{% endif %}

<script>
	// Keep the hero parallax but be defensive about missing element
	window.addEventListener("scroll", function () {
		try {
			const img = document.getElementById("hero-img");
			if (!img) return;
			const scrolled = window.scrollY || window.pageYOffset || 0;
			img.style.transform = `translateY(${scrolled * 0.3}px) scale(1.05)`; // 0.3 = parallax speed
		} catch (err) {
			// Don't propagate errors from scroll handler
			// they could cause repeated reflows leading to other issues
			// Log to console and show to client panel for visibility
			console.error('parallax handler error', err);
			if (window.__showClientError) window.__showClientError('parallax handler error: ' + (err && err.stack ? err.stack : String(err)));
		}
	}, { passive: true });
</script>
{% endblock %}
