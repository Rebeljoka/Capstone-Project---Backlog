{% extends 'base.html' %}
{% block content %}
<h1>Steam Games</h1>
{% if steam_error %}
  <div class="bg-red-100 text-red-800 p-4 rounded mb-4">{{ steam_error }}</div>
{% endif %}
<form method="get" class="mb-4 flex flex-wrap gap-4 items-center">
  <input type="text" name="search" value="{{ search_query }}" placeholder="Search games..." class="border rounded px-2 py-1" />
  <label for="genre">Genre:</label>
  <select name="genre" id="genre" onchange="this.form.submit()" class="border rounded px-2 py-1">
    <option value="">All</option>
    {% for genre_id, genre_name in genres %}
      <option value="{{ genre_id }}" {% if genre_id|stringformat:'s' == selected_genre %}selected{% endif %}>{{ genre_name }}</option>
    {% endfor %}
  </select>
  <label for="tag">Tag:</label>
  <select name="tag" id="tag" onchange="this.form.submit()" class="border rounded px-2 py-1">
    <option value="">All</option>
    {% for tag_id, tag_name in tags %}
      <option value="{{ tag_id }}" {% if tag_id|stringformat:'s' == selected_tag %}selected{% endif %}>{{ tag_name }}</option>
    {% endfor %}
  </select>
  <button type="submit" class="bg-blue-500 text-white px-4 py-1 rounded">Filter</button>
</form>
<section class="steam-game-list">
  {% for game in steam_games %}
    <div class="game-card rounded-lg shadow p-4 mb-4" style="background-color: var(--color-card-bg); color: var(--color-text-main);">
      <h2 class="text-xl font-bold mb-2">
        <a href="{% url 'game_detail' game.appid %}" class="text-blue-600 underline">{{ game.title }}</a>
      </h2>
      <p class="mb-1"><span class="font-semibold">Developer:</span> {{ game.developer }}</p>
      {% if game.image %}
        <img src="{{ game.image }}" alt="{{ game.title }} cover" class="max-w-xs mb-2 rounded" />
      {% endif %}
      <p class="mb-2">{{ game.short_description }}</p>
      
      <!-- Debug: Show raw genres data -->
      <div class="mb-2 text-xs text-gray-500">
        Debug genres: {{ game.genres|length }} items - {{ game.genres }}
      </div>
      
      <p class="mb-1">
        <span class="font-semibold">Genres:</span> 
        {% for genre in game.genres %}
          <span class="inline-block px-2 py-1 rounded mr-1" style="background-color: var(--color-decorative);">
            {{ genre.description|default:genre }}
          </span>
        {% empty %}
          <span class="text-gray-500">No genres</span>
        {% endfor %}
      </p>
      
      <p class="mb-1">
        <span class="font-semibold">Tags:</span> 
        {% for tag in game.tags %}
          <span class="inline-block px-2 py-1 rounded mr-1" style="background-color: var(--color-decorative);">
            {{ tag.description|default:tag }}
          </span>
        {% empty %}
          <span class="text-gray-500">No tags</span>
        {% endfor %}
      </p>
      
      <div class="flex gap-2 mt-4">
        <a href="{% url 'game_detail' game.appid %}" 
           class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm font-medium">
          View Details
        </a>
        {% if user.is_authenticated %}
          <a href="{% url 'add_steam_game_to_wishlist' game.appid %}" 
             class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm font-medium">
            Add to Wishlist
          </a>
        {% endif %}
      </div>
    </div>
  {% empty %}
    <div>No Steam games found.</div>
  {% endfor %}
</section>
<div class="flex justify-center mt-6">
  <div class="join">
    <!-- Previous Button -->
    {% if page_obj.has_previous %}
      <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if selected_genre %}genre={{ selected_genre }}&{% endif %}{% if selected_tag %}tag={{ selected_tag }}&{% endif %}page={{ page_obj.previous_page_number }}" class="join-item btn">«</a>
    {% else %}
      <button class="join-item btn btn-disabled">«</button>
    {% endif %}

    <!-- Page Numbers -->
    {% with page_obj.paginator.num_pages as total_pages %}
      {% with page_obj.number as current_page %}
        
        <!-- First page -->
        {% if current_page > 3 %}
          <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if selected_genre %}genre={{ selected_genre }}&{% endif %}{% if selected_tag %}tag={{ selected_tag }}&{% endif %}page=1" class="join-item btn">1</a>
          {% if current_page > 4 %}
            <button class="join-item btn btn-disabled">...</button>
          {% endif %}
        {% endif %}

        <!-- Page numbers around current page -->
        {% for page_num in page_obj.paginator.page_range %}
          {% if page_num >= current_page|add:"-2" and page_num <= current_page|add:"2" %}
            {% if page_num == current_page %}
              <button class="join-item btn btn-active">{{ page_num }}</button>
            {% else %}
              <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if selected_genre %}genre={{ selected_genre }}&{% endif %}{% if selected_tag %}tag={{ selected_tag }}&{% endif %}page={{ page_num }}" class="join-item btn">{{ page_num }}</a>
            {% endif %}
          {% endif %}
        {% endfor %}

        <!-- Last page -->
        {% if current_page < total_pages|add:"-2" %}
          {% if current_page < total_pages|add:"-3" %}
            <button class="join-item btn btn-disabled">...</button>
          {% endif %}
          <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if selected_genre %}genre={{ selected_genre }}&{% endif %}{% if selected_tag %}tag={{ selected_tag }}&{% endif %}page={{ total_pages }}" class="join-item btn">{{ total_pages }}</a>
        {% endif %}

      {% endwith %}
    {% endwith %}

    <!-- Next Button -->
    {% if page_obj.has_next %}
      <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if selected_genre %}genre={{ selected_genre }}&{% endif %}{% if selected_tag %}tag={{ selected_tag }}&{% endif %}page={{ page_obj.next_page_number }}" class="join-item btn">»</a>
    {% else %}
      <button class="join-item btn btn-disabled">»</button>
    {% endif %}
  </div>
</div>
{% endblock %}